<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CallingApp â€” Single Page</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* Fonts & Root vars */
    :root{
      --wa-header-bg: #005c97;
      --wa-accent-blue: #34B7F1;
      --wa-message-out-bg: #e1f6fb;
      --wa-message-in-bg: #ffffff;
      --wa-app-bg: #f0f2f5;
      --wa-chat-bg: #e5ddd5;
      --wa-icon-color: #f0f2f5;
      --wa-text-primary: #111b21;
      --wa-text-secondary: #667781;
      --wa-border-color: #e9edef;
      --wa-active-tab-indicator: var(--wa-accent-blue);
      --wa-button-color: #008069;
      --wa-link-color: #00a8e8;
      --wa-shadow: rgba(17, 27, 33, 0.15);
    }

    /* Reset & global */
    * { box-sizing: border-box; }
    html,body { height:100%; width:100%; margin:0; padding:0; overflow:hidden; font-family:'Roboto',sans-serif; background:#d1d7db; display:flex; align-items:center; justify-content:center; }
    /* Custom scrollbar */
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.08); border-radius:8px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* App container */
    #app-container{
      width:100%;
      max-width:450px;
      height:100%;
      max-height:950px;
      background:var(--wa-app-bg);
      border-radius:16px;
      box-shadow: 0 10px 30px var(--wa-shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
      border:1px solid var(--wa-border-color);
    }

    /* generic view panel */
    .view{ display:none; flex-direction:column; height:100%; width:100%; }
    .view.active { display:flex; }

    /* --- Auth view --- */
    #auth-view{ align-items:center; justify-content:center; padding:40px; gap:20px; }
    #auth-view h1{ font-size:28px; margin:0; color:var(--wa-header-bg); font-weight:700; }
    .auth-card{ background:#fff; width:100%; max-width:360px; border-radius:10px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,0.05); }
    form{ display:flex; flex-direction:column; gap:12px; }
    input[type="email"], input[type="password"], input[type="text"]{
      padding:12px 14px; border-radius:8px; border:1px solid var(--wa-border-color); outline:none; font-size:14px;
      background: #fbfdff;
    }
    input:focus{ box-shadow:0 0 0 3px rgba(52,183,241,0.12); border-color:var(--wa-accent-blue); }
    button.primary{
      background:var(--wa-button-color); color:#fff; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600;
    }
    a.switch-link{ color:var(--wa-link-color); font-weight:500; cursor:pointer; text-decoration:none; }

    .error{ color:#c62828; font-size:13px; margin-top:6px; display:none; }

    /* --- Main view (app) --- */
    #main-view{ display:flex; flex-direction:column; height:100%; background:transparent; }
    .main-header{ background:linear-gradient(90deg,var(--wa-header-bg), #006fb3); padding:12px; color:var(--wa-icon-color); }
    .header-top{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .header-top h2{ margin:0; font-size:18px; font-weight:700; color:white; display:flex; align-items:center; gap:8px; }
    .icon-btn{ background:transparent; border:none; padding:6px; border-radius:8px; cursor:pointer; color:var(--wa-icon-color); display:inline-flex; align-items:center; justify-content:center; }
    .icon-btn svg{ width:20px; height:20px; fill:currentColor; }

    .header-nav{ display:flex; gap:8px; margin-top:12px; }
    .nav-tab{ flex:1; text-align:center; padding:8px 6px; border-radius:8px; color:var(--wa-text-primary); background:transparent; cursor:pointer; position:relative; font-weight:600; }
    .nav-tab.active{ border-bottom:3px solid var(--wa-active-tab-indicator); color:var(--wa-active-tab-indicator); }
    .badge{ background:var(--wa-button-color); color:white; padding:2px 6px; font-size:12px; border-radius:999px; position:absolute; top:6px; right:14px; display:inline-block; min-width:20px; text-align:center; }

    #main-content{ flex:1; overflow:auto; padding:12px; background:transparent; display:flex; flex-direction:column; gap:12px; }
    .content-panel{ display:none; }
    .content-panel.active{ display:block; }

    .list { display:flex; flex-direction:column; gap:8px; }
    .list-item{
      display:flex; align-items:center; gap:12px; padding:10px; background:white; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.03);
      border:1px solid var(--wa-border-color);
    }
    .list-item .emoji-box{ width:48px; height:48px; border-radius:12px; background:var(--wa-message-in-bg); display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--wa-text-primary); }
    .list-item .details{ flex:1; display:flex; flex-direction:column; }
    .list-item .details .name{ font-weight:600; color:var(--wa-text-primary); }
    .list-item .details .sub{ font-size:13px; color:var(--wa-text-secondary); }

    /* --- Chat view --- */
    #chat-view{ position:relative; background:var(--wa-chat-bg); display:flex; flex-direction:column; }
    .chat-header{ display:flex; align-items:center; gap:10px; padding:12px; background:linear-gradient(90deg,var(--wa-header-bg),#006fb3); color:var(--wa-icon-color); }
    .chat-header .back-btn{ background:transparent; border:none; color:var(--wa-icon-color); cursor:pointer; }
    .chat-header .title{ font-weight:700; font-size:16px; }
    #chat-messages{ flex:1; overflow:auto; padding:20px; background: var(--wa-chat-bg) url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23bdbdbd' fill-opacity='0.15' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E"); background-repeat:repeat; }
    .message-bubble{ max-width:70%; padding:10px 12px; margin-bottom:8px; border-radius:12px; display:inline-block; }
    .message-sent{ margin-left:auto; background:var(--wa-message-out-bg); border-top-right-radius:4px; text-align:right; }
    .message-received{ margin-right:auto; background:var(--wa-message-in-bg); border-top-left-radius:4px; text-align:left; }

    #chat-input-container{ display:flex; gap:8px; padding:12px; border-top:1px solid var(--wa-border-color); background:#fff; align-items:center; }
    #chat-input{ flex:1; padding:10px 12px; border-radius:24px; border:1px solid var(--wa-border-color); outline:none; }
    #chat-send-btn{ background:var(--wa-accent-blue); color:white; border:none; padding:10px 12px; border-radius:12px; cursor:pointer; }

    /* --- Call views --- */
    .call-view{ position:absolute; inset:0; z-index:60; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); }
    .call-view.active{ display:flex; }
    #video-call-view video, #voice-call-view audio{ max-width:100%; }
    #remote-video{ width:100%; height:100%; object-fit:cover; background:black; border-radius:8px; }
    #local-video{ width:140px; height:100px; position:absolute; top:16px; right:16px; border-radius:8px; object-fit:cover; border:2px solid rgba(255,255,255,0.7); cursor:grab; }
    .call-overlay{ position:absolute; bottom:20px; left:50%; transform:translateX(-50%); width:calc(100% - 48px); max-width:900px; padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(0,0,0,0.24), rgba(0,0,0,0.48)); color:white; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .caller-info{ display:flex; flex-direction:column; gap:4px; }
    .call-controls{ display:flex; gap:8px; }
    .btn-end{ background:#e91e63; color:white; padding:10px 12px; border-radius:8px; border:none; }
    .btn-accept{ background:#4CAF50; color:white; padding:10px 12px; border-radius:8px; border:none; }

    /* --- Modals --- */
    .modal{ position:absolute; inset:0; background:rgba(0,0,0,0.4); z-index:80; display:none; align-items:center; justify-content:center; }
    .modal.active{ display:flex; }
    .modal-content{ background:white; padding:18px; border-radius:10px; width:100%; max-width:420px; box-shadow:0 10px 40px rgba(0,0,0,0.15); }
    .modal h3{ margin:0 0 8px 0; }
    .modal .row{ display:flex; gap:8px; margin-bottom:8px; }
    .small-muted{ font-size:13px; color:var(--wa-text-secondary); }

    /* Responsive tidbits */
    @media (max-width:420px){
      #local-video{ width:110px; height:80px; }
    }

  </style>
</head>
<body>

  <div id="app-container">

    <!-- AUTH VIEW -->
    <div id="auth-view" class="view active">
      <h1>CallingApp</h1>
      <div class="auth-card">
        <form id="login-form">
          <input id="login-email" type="email" placeholder="Email" required />
          <input id="login-password" type="password" placeholder="Password" required />
          <button type="submit" class="primary">Log In</button>
          <div id="login-error" class="error">Error message</div>
          <div style="text-align:center; margin-top:8px;">
            <a id="to-signup" class="switch-link">Don't have an account? Sign up</a>
          </div>
        </form>

        <form id="signup-form" style="display:none; margin-top:12px;">
          <input id="signup-email" type="email" placeholder="Email" required />
          <input id="signup-password" type="password" placeholder="Password" required />
          <input id="signup-username" type="text" placeholder="Choose a username (unique)" required />
          <button type="submit" class="primary">Sign Up</button>
          <div id="signup-error" class="error">Error message</div>
          <div style="text-align:center; margin-top:8px;">
            <a id="to-login" class="switch-link">Already have an account? Log in</a>
          </div>
        </form>
      </div>
    </div>

    <!-- MAIN APP VIEW -->
    <div id="main-view" class="view">

      <header class="main-header">
        <div class="header-top">
          <h2>CallingApp</h2>
          <div style="display:flex; gap:8px;">
            <button id="add-friend-btn" class="icon-btn" title="Add Friend">
              <!-- SVG icon: user-plus -->
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 14c2.761 0 5 2.239 5 5v1H4v-1c0-2.761 2.239-5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="8" r="4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 8v6M22 11h-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button id="menu-btn" class="icon-btn" title="Profile & Settings">
              <!-- SVG icon: menu/user -->
              <svg viewBox="0 0 24 24"><path d="M12 12c2.761 0 5 2.239 5 5v1H7v-1c0-2.761 2.239-5 5-5zM12 7a3 3 0 100-6 3 3 0 000 6z" fill="currentColor"/></svg>
            </button>
          </div>
        </div>

        <nav class="header-nav">
          <div id="nav-home" class="nav-tab active">Chats <span id="badge-home" class="badge" style="display:none">0</span></div>
          <div id="nav-notifications" class="nav-tab">Updates <span id="badge-notifications" class="badge" style="display:none">0</span></div>
          <div id="nav-calls" class="nav-tab">Calls <span id="badge-calls" class="badge" style="display:none">0</span></div>
        </nav>
      </header>

      <main id="main-content">
        <!-- HOME / CHATS -->
        <section id="home-content" class="content-panel active">
          <div class="list" id="contacts-list">
            <!-- contacts inserted here -->
          </div>
        </section>

        <!-- UPDATES (friend requests) -->
        <section id="notifications-content" class="content-panel">
          <h3 style="margin:0 0 8px 0;">Friend Requests</h3>
          <div id="requests-list" class="list"></div>
        </section>

        <!-- CALLS -->
        <section id="calls-content" class="content-panel">
          <h3 style="margin:0 0 8px 0;">Recent Calls</h3>
          <div id="call-logs" class="list"></div>
        </section>
      </main>

    </div>

    <!-- CHAT VIEW -->
    <div id="chat-view" class="view">
      <div class="chat-header">
        <button id="chat-back-btn" class="back-btn icon-btn" title="Back">
          <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div class="title" id="chat-title">Username</div>
        <div style="margin-left:auto; display:flex; gap:6px;">
          <button id="voice-call-btn" class="icon-btn" title="Voice Call">
            <svg viewBox="0 0 24 24"><path d="M15.05 5.05L19 9m-6-2a9 9 0 00-6 6l-2 3 4-0.5A5 5 0 0119 13l1.5-4.5" stroke="currentColor" stroke-width="1.6" fill="none"/></svg>
          </button>
          <button id="video-call-btn" class="icon-btn" title="Video Call">
            <svg viewBox="0 0 24 24"><path d="M23 7l-7 5v-4L23 7zM1 6h14v12H1z" fill="currentColor"/></svg>
          </button>
          <button id="chat-more-btn" class="icon-btn" title="More">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="19" cy="12" r="1.5" fill="currentColor"/><circle cx="5" cy="12" r="1.5" fill="currentColor"/></svg>
          </button>
        </div>
      </div>

      <div id="chat-messages"></div>

      <div id="chat-input-container">
        <input id="chat-input" placeholder="Type a message..." />
        <button id="chat-send-btn">Send</button>
      </div>
    </div>

    <!-- CALL VIEWS -->
    <div id="video-call-view" class="call-view">
      <video id="remote-video" autoplay playsinline></video>
      <video id="local-video" autoplay muted playsinline></video>
      <div class="call-overlay">
        <div class="caller-info">
          <div id="call-peer-name" style="font-weight:700;">Caller</div>
          <div class="small-muted" id="call-state">Connecting...</div>
        </div>
        <div class="call-controls">
          <button id="accept-call-btn" class="btn-accept">Accept</button>
          <button id="end-call-btn" class="btn-end">End Call</button>
        </div>
      </div>
    </div>

    <div id="voice-call-view" class="call-view">
      <audio id="remote-audio" autoplay></audio>
      <div class="call-overlay">
        <div class="caller-info">
          <div id="call-peer-name-voice" style="font-weight:700;">Caller</div>
          <div class="small-muted" id="call-state-voice">Connecting...</div>
        </div>
        <div class="call-controls">
          <button id="accept-call-btn-voice" class="btn-accept">Accept</button>
          <button id="end-call-btn-voice" class="btn-end">End Call</button>
        </div>
      </div>
    </div>

    <!-- MODALS -->
    <div id="profile-setup-modal" class="modal">
      <div class="modal-content">
        <h3>Complete your profile</h3>
        <div class="small-muted">Choose a username to be discovered by others.</div>
        <div style="height:12px;"></div>
        <div class="row">
          <input id="profile-username-input" type="text" placeholder="Your username" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--wa-border-color)" />
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button id="save-profile-btn" class="primary">Save Profile</button>
        </div>
        <div id="profile-setup-error" class="error">Error</div>
      </div>
    </div>

    <div id="add-friend-modal" class="modal">
      <div class="modal-content">
        <h3>Add Friend</h3>
        <div class="small-muted">Enter their username to send a friend request.</div>
        <div style="height:12px;"></div>
        <div class="row">
          <input id="friend-username-input" type="text" placeholder="friend's username" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--wa-border-color)" />
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button id="send-friend-request-btn" class="primary">Send Request</button>
        </div>
        <div id="add-friend-error" class="error">Error</div>
      </div>
    </div>

    <div id="profile-view-modal" class="modal">
      <div class="modal-content">
        <h3>Your Profile</h3>
        <div class="small-muted">Name: <span id="profile-name-display"></span></div>
        <div class="small-muted">Username: <span id="profile-username-display"></span></div>
        <div style="height:12px;"></div>
        <h4>Blocked Users</h4>
        <div id="blocked-list" class="list"></div>
        <div style="height:12px;"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="logout-btn" class="primary" style="background:#c62828;">Logout</button>
        </div>
      </div>
    </div>

    <div id="incoming-call-modal" class="modal">
      <div class="modal-content">
        <h3>Incoming Call</h3>
        <div class="small-muted" id="incoming-from">From: ...</div>
        <div style="height:12px;"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="incoming-accept" class="btn-accept">Accept</button>
          <button id="incoming-reject" class="btn-end">Reject</button>
        </div>
      </div>
    </div>

    <!-- Ringtone audio (placeholder tiny base64 wav) -->
    <audio id="ringtone" loop>
      <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
    </audio>

  </div>

  <!-- Firebase v8.10.1 (gstatic CDN) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Application Script -->
  <script>
  /************************************************************************
   * CallingApp â€” Single-file SPA
   * - Uses Firebase Realtime Database & Auth (v8 SDK included above)
   * - Uses WebRTC (RTCPeerConnection) for P2P calls
   * - Username-based friend request system (search by username)
   *
   * NOTE: Replace firebaseConfig with your project values to run.
   ************************************************************************/

  /************************
   * Firebase Initialization
   ************************/
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "your-app.firebaseapp.com",
    databaseURL: "https://your-app-default-rtdb.firebaseio.com",
    projectId: "your-app",
    storageBucket: "your-app.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef123456"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  /************************
   * Global State
   ************************/
  let currentUser = null; // firebase auth user object
  let currentProfile = null; // profile data from db (username, name, blocked list)
  let currentChatPartner = null; // { uid, username }
  let peerConnection = null;
  let localStream = null;
  let remoteStream = null;
  let currentCallId = null;
  let isVideoCall = false;

  /************************
   * Helpers: View & Modal toggles
   ************************/
  function showView(id) {
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    const el = document.getElementById(id);
    if(el) el.classList.add('active');
  }
  function showModal(id, show=true) {
    const el = document.getElementById(id);
    if(!el) return;
    if(show) el.classList.add('active'); else el.classList.remove('active');
  }
  function showPanel(panelId) {
    document.querySelectorAll('.content-panel').forEach(p=>p.classList.remove('active'));
    const p = document.getElementById(panelId);
    if(p) p.classList.add('active');
  }

  /************************
   * DOM references
   ************************/
  const loginForm = document.getElementById('login-form');
  const signupForm = document.getElementById('signup-form');
  const toSignupLink = document.getElementById('to-signup');
  const toLoginLink = document.getElementById('to-login');
  const loginError = document.getElementById('login-error');
  const signupError = document.getElementById('signup-error');

  const navHome = document.getElementById('nav-home');
  const navNotifications = document.getElementById('nav-notifications');
  const navCalls = document.getElementById('nav-calls');
  const badgeHome = document.getElementById('badge-home');
  const badgeNotifications = document.getElementById('badge-notifications');
  const badgeCalls = document.getElementById('badge-calls');

  const contactsList = document.getElementById('contacts-list');
  const requestsList = document.getElementById('requests-list');
  const callLogsList = document.getElementById('call-logs');

  const addFriendBtn = document.getElementById('add-friend-btn');
  const addFriendModal = document.getElementById('add-friend-modal');
  const sendFriendRequestBtn = document.getElementById('send-friend-request-btn');
  const friendUsernameInput = document.getElementById('friend-username-input');
  const addFriendError = document.getElementById('add-friend-error');

  const profileSetupModal = document.getElementById('profile-setup-modal');
  const saveProfileBtn = document.getElementById('save-profile-btn');
  const profileUsernameInput = document.getElementById('profile-username-input');
  const profileSetupError = document.getElementById('profile-setup-error');

  const profileViewModal = document.getElementById('profile-view-modal');
  const menuBtn = document.getElementById('menu-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const profileNameDisplay = document.getElementById('profile-name-display');
  const profileUsernameDisplay = document.getElementById('profile-username-display');
  const blockedListEl = document.getElementById('blocked-list');

  // Chat DOM
  const chatView = document.getElementById('chat-view');
  const chatTitle = document.getElementById('chat-title');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSendBtn = document.getElementById('chat-send-btn');
  const chatBackBtn = document.getElementById('chat-back-btn');

  // Call DOM
  const videoCallView = document.getElementById('video-call-view');
  const voiceCallView = document.getElementById('voice-call-view');
  const remoteVideo = document.getElementById('remote-video');
  const localVideo = document.getElementById('local-video');
  const remoteAudio = document.getElementById('remote-audio');
  const acceptCallBtn = document.getElementById('accept-call-btn');
  const endCallBtn = document.getElementById('end-call-btn');
  const acceptCallBtnVoice = document.getElementById('accept-call-btn-voice');
  const endCallBtnVoice = document.getElementById('end-call-btn-voice');

  // incoming call modal
  const incomingCallModal = document.getElementById('incoming-call-modal');
  const incomingFrom = document.getElementById('incoming-from');
  const incomingAccept = document.getElementById('incoming-accept');
  const incomingReject = document.getElementById('incoming-reject');

  // audio
  const ringtone = document.getElementById('ringtone');

  /************************
   * UI: Nav handlers
   ************************/
  navHome.addEventListener('click', ()=> {
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    navHome.classList.add('active'); showPanel('home-content');
  });
  navNotifications.addEventListener('click', ()=> {
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    navNotifications.classList.add('active'); showPanel('notifications-content');
  });
  navCalls.addEventListener('click', ()=> {
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    navCalls.classList.add('active'); showPanel('calls-content');
  });

  /************************
   * Auth: login / signup flows
   ************************/
  toSignupLink.addEventListener('click', ()=> {
    document.getElementById('login-form').style.display='none';
    document.getElementById('signup-form').style.display='block';
  });
  toLoginLink.addEventListener('click', ()=> {
    document.getElementById('signup-form').style.display='none';
    document.getElementById('login-form').style.display='block';
  });

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginError.style.display='none';
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    try {
      await auth.signInWithEmailAndPassword(email,password);
      // onAuthStateChanged will handle UI changes
    } catch(err) {
      loginError.textContent = err.message; loginError.style.display='block';
    }
  });

  signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    signupError.style.display='none';
    const email = document.getElementById('signup-email').value.trim();
    const password = document.getElementById('signup-password').value;
    const username = document.getElementById('signup-username').value.trim().toLowerCase();
    if(!username.match(/^[a-z0-9\-_]{3,20}$/)) {
      signupError.textContent = "Username must be 3-20 chars, letters/numbers/-/_ only."; signupError.style.display='block'; return;
    }
    try {
      // Check username availability before creating account
      const snapshot = await db.ref('usernames/'+username).once('value');
      if(snapshot.exists()){
        signupError.textContent = "Username already taken."; signupError.style.display='block'; return;
      }
      const res = await auth.createUserWithEmailAndPassword(email,password);
      // mark username reserved under their uid once profile created (handled by profile setup)
      // show profile setup modal after sign up
      showModal('profile-setup-modal', true);
    } catch(err) {
      signupError.textContent = err.message; signupError.style.display='block';
    }
  });

  // Logout
  logoutBtn.addEventListener('click', async ()=> {
    await auth.signOut();
    // reset local state
    currentUser = null; currentProfile = null;
    showView('auth-view');
    showModal('profile-view-modal', false);
  });

  /************************
   * Profile Setup & Management
   ************************/
  saveProfileBtn.addEventListener('click', async ()=>{
    profileSetupError.style.display='none';
    const username = profileUsernameInput.value.trim().toLowerCase();
    if(!username.match(/^[a-z0-9\-_]{3,20}$/)){
      profileSetupError.textContent = "Username invalid. 3-20 chars, letters/numbers/-/_"; profileSetupError.style.display='block'; return;
    }
    try {
      // reserve username atomically
      const usernameRef = db.ref('usernames/'+username);
      const snapshot = await usernameRef.once('value');
      if(snapshot.exists()){ profileSetupError.textContent = "Username already taken."; profileSetupError.style.display='block'; return; }

      const uid = auth.currentUser.uid;
      // set profile
      const profile = { uid, username, createdAt: Date.now(), blocked: {} };
      await db.ref('users/'+uid).set(profile);
      // set reverse lookup
      await usernameRef.set(uid);
      currentProfile = profile;
      showModal('profile-setup-modal', false);
      initializeAppForUser(); // move to main view & listeners
    } catch(err){
      profileSetupError.textContent = err.message; profileSetupError.style.display='block';
    }
  });

  menuBtn.addEventListener('click', ()=>{
    // load profile info
    if(currentProfile){
      profileNameDisplay.textContent = currentProfile.name || '(no name)';
      profileUsernameDisplay.textContent = currentProfile.username || '(no username)';
      // blocked list
      blockedListEl.innerHTML = '';
      const blocked = currentProfile.blocked || {};
      Object.keys(blocked).forEach(buid=>{
        const item = document.createElement('div'); item.className='list-item';
        item.innerHTML = '<div class="details"><div class="name">'+blocked[buid].username+'</div><div class="sub">UID: '+buid+'</div></div><div><button class="icon-btn unblock-btn" data-uid="'+buid+'">Unblock</button></div>';
        blockedListEl.appendChild(item);
      });
      // attach unblock handlers
      blockedListEl.querySelectorAll('.unblock-btn').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const buid = e.currentTarget.dataset.uid;
          await db.ref('users/'+currentUser.uid+'/blocked/'+buid).remove();
        });
      });
    }
    showModal('profile-view-modal', true);
  });

  // Watch for profile changes (blocked list changes, etc.)
  function listenProfile(uid){
    const pRef = db.ref('users/'+uid);
    pRef.on('value', snapshot=>{
      const data = snapshot.val();
      currentProfile = data;
      // update UI badges & blocked list if modal visible
      if(profileViewModal.classList.contains('active')){
        profileNameDisplay.textContent = data.name || '(no name)';
        profileUsernameDisplay.textContent = data.username || '(no username)';
        blockedListEl.innerHTML = '';
        const blocked = data.blocked || {};
        Object.keys(blocked).forEach(buid=>{
          const item = document.createElement('div'); item.className='list-item';
          item.innerHTML = '<div class="details"><div class="name">'+blocked[buid].username+'</div><div class="sub">UID: '+buid+'</div></div><div><button class="icon-btn unblock-btn" data-uid="'+buid+'">Unblock</button></div>';
          blockedListEl.appendChild(item);
        });
      }
    });
  }

  /************************
   * Friend / Contacts System (username-based)
   ************************/
  addFriendBtn.addEventListener('click', ()=> {
    friendUsernameInput.value = '';
    addFriendError.style.display='none';
    showModal('add-friend-modal', true);
  });

  sendFriendRequestBtn.addEventListener('click', async ()=>{
    addFriendError.style.display='none';
    const targetUsername = friendUsernameInput.value.trim().toLowerCase();
    if(!targetUsername){ addFriendError.textContent='Enter a username'; addFriendError.style.display='block'; return; }
    if(!currentProfile){ addFriendError.textContent='You must complete your profile first.'; addFriendError.style.display='block'; return; }
    try {
      // look up username -> uid
      const snap = await db.ref('usernames/'+targetUsername).once('value');
      if(!snap.exists()){ addFriendError.textContent='User not found.'; addFriendError.style.display='block'; return; }
      const targetUid = snap.val();
      if(targetUid === currentUser.uid){ addFriendError.textContent='Cannot add yourself.'; addFriendError.style.display='block'; return; }

      // check if blocked by them
      const theirBlocked = await db.ref('users/'+targetUid+'/blocked/'+currentUser.uid).once('value');
      if(theirBlocked.exists()){ addFriendError.textContent='Cannot send request â€” you are blocked.'; addFriendError.style.display='block'; return; }

      // push request under requests/{targetUid}/{requestId}
      const reqRef = db.ref('requests/'+targetUid).push();
      await reqRef.set({
        fromUid: currentUser.uid,
        fromUsername: currentProfile.username,
        timestamp: Date.now()
      });
      showModal('add-friend-modal', false);
      alert('Request sent!');
    } catch(err){
      addFriendError.textContent = err.message; addFriendError.style.display='block';
    }
  });

  // Listen for incoming friend requests for current user
  let requestsListener = null;
  function listenForRequests(uid){
    if(requestsListener) requestsListener.off();
    const rRef = db.ref('requests/'+uid);
    rRef.on('value', snap=>{
      const data = snap.val() || {};
      // render list
      requestsList.innerHTML = '';
      const keys = Object.keys(data);
      if(keys.length === 0){
        requestsList.innerHTML = '<div class="small-muted">No requests</div>';
        badgeNotifications.style.display='none';
      } else {
        badgeNotifications.style.display='inline-block';
        badgeNotifications.textContent = keys.length;
        keys.forEach(k=>{
          const r = data[k];
          const item = document.createElement('div'); item.className='list-item';
          item.innerHTML = '<div class="details"><div class="name">'+r.fromUsername+'</div><div class="sub">UID: '+r.fromUid+'</div></div><div style="display:flex; gap:6px;"><button class="icon-btn accept-req" data-key="'+k+'">Accept</button><button class="icon-btn reject-req" data-key="'+k+'">Reject</button></div>';
          requestsList.appendChild(item);
        });
        // attach handlers
        requestsList.querySelectorAll('.accept-req').forEach(btn=>{
          btn.addEventListener('click', async (e)=>{
            const key = e.currentTarget.dataset.key;
            const r = data[key];
            await acceptFriendRequest(key, r);
          });
        });
        requestsList.querySelectorAll('.reject-req').forEach(btn=>{
          btn.addEventListener('click', async (e)=>{
            const key = e.currentTarget.dataset.key;
            await db.ref('requests/'+uid+'/'+key).remove();
          });
        });
      }
    });
    requestsListener = rRef;
  }

  async function acceptFriendRequest(key, request){
    // Add each other to contacts
    const myUid = currentUser.uid;
    const theirUid = request.fromUid;

    // ensure not blocked by me
    const blocked = currentProfile.blocked || {};
    if(blocked[theirUid]){ alert('User is blocked. Cannot accept.'); return; }

    // create contact entries under contacts/{uid}/{otherUid}
    await db.ref('contacts/'+myUid+'/'+theirUid).set({ uid: theirUid, username: request.fromUsername, since: Date.now() });
    await db.ref('contacts/'+theirUid+'/'+myUid).set({ uid: myUid, username: currentProfile.username, since: Date.now() });

    // remove request
    await db.ref('requests/'+myUid+'/'+key).remove();
  }

  // Listen to contacts list
  let contactsListener = null;
  function listenForContacts(uid){
    if(contactsListener) contactsListener.off();
    const cRef = db.ref('contacts/'+uid);
    cRef.on('value', snap=>{
      const data = snap.val() || {};
      contactsList.innerHTML = '';
      const keys = Object.keys(data);
      if(keys.length === 0){
        contactsList.innerHTML = '<div class="small-muted">No contacts yet. Add friends by username.</div>';
        badgeHome.style.display='none';
      } else {
        // count unread messages to decide badge
        const unreadRef = db.ref('unreadCounts/'+uid);
        unreadRef.once('value').then(uSnap=>{
          const unread = uSnap.val() || {};
          let totalUnread = 0;
          keys.forEach(k=>{
            const c = data[k];
            const item = document.createElement('div'); item.className='list-item';
            item.innerHTML = '<div class="emoji-box">ðŸ‘¤</div><div class="details"><div class="name">'+c.username+'</div><div class="sub">Since '+(new Date(c.since).toLocaleDateString())+'</div></div><div><button class="icon-btn open-chat" data-uid="'+c.uid+'" data-username="'+c.username+'">Open</button></div>';
            contactsList.appendChild(item);
            const unreadCount = unread[c.uid] || 0;
            if(unreadCount>0) totalUnread += unreadCount;
          });
          if(totalUnread>0){ badgeHome.style.display='inline-block'; badgeHome.textContent = totalUnread; } else badgeHome.style.display='none';
        });
        // attach open-chat handlers (delegation)
        contactsList.querySelectorAll('.open-chat').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            const uid = e.currentTarget.dataset.uid;
            const username = e.currentTarget.dataset.username;
            openChatWith({ uid, username });
          });
        });
      }
    });
    contactsListener = cRef;
  }

  /************************
   * Messaging
   ************************/
  function chatIdFor(u1, u2){
    // deterministic key: sort uids
    return [u1,u2].sort().join('_');
  }

  let messagesListenerRef = null;
  function openChatWith(partner){
    currentChatPartner = partner;
    chatTitle.textContent = partner.username;
    showView('chat-view');
    // mark unread to zero
    db.ref('unreadCounts/'+currentUser.uid+'/'+partner.uid).set(0);

    // listen to messages
    const cid = chatIdFor(currentUser.uid, partner.uid);
    if(messagesListenerRef) messagesListenerRef.off();
    const mRef = db.ref('messages/'+cid);
    mRef.on('value', snap=>{
      const data = snap.val() || {};
      renderMessages(data, currentUser.uid);
    });
    messagesListenerRef = mRef;
  }

  function renderMessages(messagesObj, myUid){
    chatMessages.innerHTML = '';
    const keys = Object.keys(messagesObj || {});
    keys.sort((a,b)=> messagesObj[a].timestamp - messagesObj[b].timestamp );
    keys.forEach(k=>{
      const m = messagesObj[k];
      const div = document.createElement('div');
      div.className = 'message-bubble ' + (m.from === myUid ? 'message-sent' : 'message-received');
      div.innerHTML = '<div style="font-size:13px;">'+escapeHtml(m.text)+'</div><div style="font-size:11px; color:var(--wa-text-secondary); margin-top:6px;">'+new Date(m.timestamp).toLocaleTimeString()+'</div>';
      chatMessages.appendChild(div);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  chatSendBtn.addEventListener('click', sendChatMessage);
  chatInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ sendChatMessage(); } });

  async function sendChatMessage(){
    const text = chatInput.value.trim();
    if(!text || !currentChatPartner) return;
    const cid = chatIdFor(currentUser.uid, currentChatPartner.uid);
    const msgRef = db.ref('messages/'+cid).push();
    const message = { from: currentUser.uid, to: currentChatPartner.uid, text, timestamp: Date.now() };
    await msgRef.set(message);
    chatInput.value = '';
    // increment unread for recipient
    const unreadRef = db.ref('unreadCounts/'+currentChatPartner.uid+'/'+currentUser.uid);
    unreadRef.transaction((v)=>{
      return (v || 0) + 1;
    });
  }

  /************************
   * Unread counts listener (update badges)
   ************************/
  let unreadListener = null;
  function listenUnreadCounts(uid){
    if(unreadListener) unreadListener.off();
    const uRef = db.ref('unreadCounts/'+uid);
    uRef.on('value', snap=>{
      const data = snap.val() || {};
      let totalUnread = 0;
      Object.values(data).forEach(v => totalUnread += v || 0);
      if(totalUnread>0){ badgeHome.style.display='inline-block'; badgeHome.textContent = totalUnread; } else badgeHome.style.display='none';
    });
    unreadListener = uRef;
  }

  /************************
   * WebRTC: Calling logic
   *
   * Basic flow:
   * - Caller creates offer, writes to calls/{calleeUid}/{callId}
   * - Callee listens to calls/{currentUser.uid} and sees incoming call entries
   * - Callee accepts: creates answer & writes into same call entry; both exchange ICE under iceCandidates/{callId}/{role}
   ************************/
  // Utility to create RTCPeerConnection and attach handlers
  function createPeerConnection(callId, isCaller){
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    pc.onicecandidate = (e) => {
      if(e.candidate){
        const path = 'iceCandidates/'+callId+'/'+(isCaller ? 'caller' : 'callee');
        db.ref(path).push(e.candidate.toJSON());
      }
    };
    pc.ontrack = (e) => {
      // stream from remote
      if(e.streams && e.streams[0]){
        if(isVideoCall){
          remoteVideo.srcObject = e.streams[0];
        } else {
          remoteAudio.srcObject = e.streams[0];
        }
      }
    };
    return pc;
  }

  // Start call (caller)
  async function startCallWith(partnerUid, partnerUsername, video=true){
    isVideoCall = video;
    currentCallId = db.ref('calls/'+partnerUid).push().key; // create id locally (will also be used by callee)
    const callPath = 'calls/'+partnerUid+'/'+currentCallId;
    // get local media
    try {
      localStream = await navigator.mediaDevices.getUserMedia(video ? { audio:true, video:true } : { audio:true });
      // show outgoing call UI (for caller, we show remote as blank until ontrack)
      if(video){
        showCallViewVideo();
        localVideo.srcObject = localStream;
      } else {
        showCallViewVoice();
      }

      peerConnection = createPeerConnection(currentCallId, true);
      // add local tracks
      localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

      // create offer
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      // write call entry for callee to see
      await db.ref(callPath).set({
        callId: currentCallId,
        fromUid: currentUser.uid,
        fromUsername: currentProfile.username,
        video: !!video,
        offer: offer.toJSON(),
        timestamp: Date.now()
      });

      // listen for answer
      const callRef = db.ref(callPath);
      callRef.on('value', async snap=>{
        const data = snap.val();
        if(!data) return;
        if(data.answer && data.answer.sdp && peerConnection && !peerConnection.currentRemoteDescription){
          const remoteDesc = new RTCSessionDescription(data.answer);
          await peerConnection.setRemoteDescription(remoteDesc);
        }
      });

      // listen for callee ICE candidates
      const iceRef = db.ref('iceCandidates/'+currentCallId+'/callee');
      iceRef.on('child_added', async s=>{
        const cand = s.val();
        try{ await peerConnection.addIceCandidate(new RTCIceCandidate(cand)); } catch(err){ console.warn('ICE add failed', err); }
      });

      currentCallId = currentCallId;

    } catch(err){
      console.error('call start error', err);
      endCallCleanup();
      alert('Could not start call: '+err.message);
    }
  }

  // Receive call listener: listen to any new child in calls/{currentUser.uid}
  let incomingCallsRef = null;
  function listenIncomingCalls(uid){
    if(incomingCallsRef) incomingCallsRef.off();
    const cRef = db.ref('calls/'+uid);
    cRef.on('child_added', snap=>{
      const call = snap.val();
      if(!call) return;
      // check blocked
      const blocked = (currentProfile && currentProfile.blocked) || {};
      if(blocked[call.fromUid]) {
        // auto reject / ignore
        db.ref('calls/'+uid+'/'+snap.key).remove();
        return;
      }
      // show incoming call UI and ringtone
      currentCallId = call.callId || snap.key;
      incomingFrom.textContent = 'From: '+(call.fromUsername || call.fromUid);
      ringtone.play().catch(()=>{});
      showModal('incoming-call-modal', true);

      // store temp data for accept flow
      incomingCallModal.dataset.callKey = snap.key;
      incomingCallModal.dataset.callerUid = call.fromUid;
      incomingCallModal.dataset.video = call.video ? '1' : '0';
      incomingCallModal.dataset.offer = JSON.stringify(call.offer || {});
    });
    incomingCallsRef = cRef;
  }

  incomingAccept.addEventListener('click', async ()=>{
    // accept call: set up local stream, create pc, set remote desc from offer, create answer and write it
    ringtone.pause(); ringtone.currentTime=0;
    showModal('incoming-call-modal', false);
    const callKey = incomingCallModal.dataset.callKey;
    const callerUid = incomingCallModal.dataset.callerUid;
    isVideoCall = incomingCallModal.dataset.video === '1';

    try {
      localStream = await navigator.mediaDevices.getUserMedia(isVideoCall ? { video:true, audio:true } : { audio:true });
      if(isVideoCall){
        showCallViewVideo();
        localVideo.srcObject = localStream;
      } else {
        showCallViewVoice();
      }

      peerConnection = createPeerConnection(callKey, false);
      localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

      const offer = JSON.parse(incomingCallModal.dataset.offer);
      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);

      // write answer into calls/{myUid}/{callKey}/answer
      await db.ref('calls/'+currentUser.uid+'/'+callKey+'/answer').set(answer.toJSON());

      // listen for caller ICE candidates
      const callerIceRef = db.ref('iceCandidates/'+callKey+'/caller');
      callerIceRef.on('child_added', async s=>{
        try{ await peerConnection.addIceCandidate(new RTCIceCandidate(s.val())); } catch(err){ console.warn('addIce fail', err); }
      });

      // write our ICE candidates will happen via createPeerConnection

      // handle end-of-call by monitoring calls node removal
      const callWatcher = db.ref('calls/'+currentUser.uid+'/'+callKey);
      callWatcher.on('value', snap=>{
        if(!snap.exists()){
          // call removed -> ended
          endCallCleanup();
          callWatcher.off();
        }
      });

    } catch(err){
      console.error('accept fail', err);
      endCallCleanup();
    }
  });

  incomingReject.addEventListener('click', async ()=>{
    ringtone.pause(); ringtone.currentTime=0;
    showModal('incoming-call-modal', false);
    const callKey = incomingCallModal.dataset.callKey;
    // remove call entry so caller knows it was rejected
    await db.ref('calls/'+currentUser.uid+'/'+callKey).remove();
  });

  // End call
  endCallBtn.addEventListener('click', endCall);
  endCallBtnVoice.addEventListener('click', endCall);

  function endCall(){
    // remove DB entries related to call (calls/{peer}/{callId}, iceCandidates/{callId})
    if(currentCallId){
      // Try removing both caller and callee sides
      db.ref('calls/'+currentUser.uid+'/'+currentCallId).remove().catch(()=>{});
      // also remove any entries under calls/{otherUid}/{callId} - best-effort unknown other uid
      // remove iceCandidates
      db.ref('iceCandidates/'+currentCallId).remove().catch(()=>{});
    }
    endCallCleanup();
  }

  function endCallCleanup(){
    ringtone.pause(); ringtone.currentTime=0;
    // stop local stream
    if(localStream){
      localStream.getTracks().forEach(t=>t.stop());
      localStream = null;
    }
    // close peer
    if(peerConnection){
      try{ peerConnection.close(); } catch(e){}
      peerConnection = null;
    }
    // hide call UI
    hideCallViews();
    currentCallId = null;
    isVideoCall = false;
  }

  function showCallViewVideo(){
    document.querySelectorAll('.call-view').forEach(v=>v.classList.remove('active'));
    videoCallView.classList.add('active');
  }
  function showCallViewVoice(){
    document.querySelectorAll('.call-view').forEach(v=>v.classList.remove('active'));
    voiceCallView.classList.add('active');
  }
  function hideCallViews(){
    document.querySelectorAll('.call-view').forEach(v=>v.classList.remove('active'));
    if(remoteVideo) remoteVideo.srcObject = null;
    if(localVideo) localVideo.srcObject = null;
    if(remoteAudio) remoteAudio.srcObject = null;
  }

  // Caller UI: when user clicks voice/video call buttons in chat header
  document.getElementById('voice-call-btn').addEventListener('click', ()=>{
    if(!currentChatPartner) return alert('Open a chat first.');
    startCallWith(currentChatPartner.uid, currentChatPartner.username, false);
  });
  document.getElementById('video-call-btn').addEventListener('click', ()=>{
    if(!currentChatPartner) return alert('Open a chat first.');
    startCallWith(currentChatPartner.uid, currentChatPartner.username, true);
  });

  /************************
   * Blocking/unblocking
   ************************/
  async function blockUser(blockUid, blockUsername){
    await db.ref('users/'+currentUser.uid+'/blocked/'+blockUid).set({ username:blockUsername, since:Date.now() });
  }
  async function unblockUser(blockUid){
    await db.ref('users/'+currentUser.uid+'/blocked/'+blockUid).remove();
  }

  /************************
   * Utils
   ************************/
  function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
  }

  /************************
   * Initialization: Auth state check
   ************************/
  auth.onAuthStateChanged(async (user)=>{
    if(user){
      currentUser = user;
      // fetch profile from db
      const profileSnap = await db.ref('users/'+user.uid).once('value');
      const profile = profileSnap.val();
      if(!profile){
        // show profile setup modal
        showModal('profile-setup-modal', true);
        showView('auth-view'); // keep auth view hidden or show? We keep auth view until user completes profile => then main view
      } else {
        currentProfile = profile;
        // move to main view & attach listeners
        initializeAppForUser();
      }
    } else {
      // not logged in
      currentUser = null; currentProfile = null;
      showView('auth-view');
    }
  });

  async function initializeAppForUser(){
    showView('main-view');
    // start listeners
    listenProfile(currentUser.uid);
    listenForRequests(currentUser.uid);
    listenForContacts(currentUser.uid);
    listenUnreadCounts(currentUser.uid);
    listenIncomingCalls(currentUser.uid);

    // load call logs
    const callLogsRef = db.ref('callLogs/'+currentUser.uid);
    callLogsRef.on('value', snap=>{
      const logs = snap.val() || {};
      callLogsList.innerHTML = '';
      const keys = Object.keys(logs);
      if(keys.length===0){ callLogsList.innerHTML = '<div class="small-muted">No calls logged yet.</div>'; badgeCalls.style.display='none'; }
      else {
        keys.reverse();
        keys.forEach(k=>{
          const c = logs[k];
          const item = document.createElement('div'); item.className='list-item';
          item.innerHTML = '<div class="emoji-box">ðŸ“ž</div><div class="details"><div class="name">'+c.withUsername+'</div><div class="sub">'+(c.type || 'call')+' at '+new Date(c.timestamp).toLocaleString()+'</div></div>';
          callLogsList.appendChild(item);
        });
      }
    });
  }

  /************************
   * Clean up on window unload
   ************************/
  window.addEventListener('beforeunload', ()=> {
    try{ if(peerConnection) peerConnection.close(); } catch(e){}
  });

  // Small helper: allow closing modals by clicking outside content
  document.querySelectorAll('.modal').forEach(modal=>{
    modal.addEventListener('click', (e)=>{
      if(e.target === modal){
        modal.classList.remove('active');
      }
    });
  });

  // Close profile view modal by clicking outside also handled above
  // Close add-friend modal, profile-setup via outside click

  // Chat back button -> main view
  chatBackBtn.addEventListener('click', ()=>{
    if(messagesListenerRef) messagesListenerRef.off();
    currentChatPartner = null;
    showView('main-view');
  });

  // Ensure UI elements exist before referencing in some flows
  // End of script
  </script>
</body>
</html>